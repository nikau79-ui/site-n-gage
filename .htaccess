# ====================================================
# .HTACCESS OPTIMISÉ HOSTINGER - N-GAGE (2025-08-22)
# Cache-busting + Blog + SEO amélioré + Embeds OK
# ====================================================

# ---------- Sécurité fichiers sensibles ----------
<Files ~ "^\.ht">
  Order allow,deny
  Deny from all
</Files>
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|bak)$">
  Order allow,deny
  Deny from all
</FilesMatch>
Options -Indexes
ServerSignature Off

# ---------- Canonical & HTTPS ----------
RewriteEngine On
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} !^www\.n-gage\.fr$ [NC]
RewriteRule ^ https://www.n-gage.fr%{REQUEST_URI} [L,R=301]

# ---------- CACHE-BUSTING : ?v= ----------
RewriteCond %{QUERY_STRING} ^v=(.*)$ [NC]
RewriteRule ^(.+\.(css|js|webp|jpg|jpeg|png|gif|svg))$ /$1? [L]

# ---------- Brotli + Gzip ----------
<IfModule mod_brotli.c>
  BrotliCompressionLevel 6
  AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css text/javascript application/xml application/xhtml+xml application/rss+xml application/javascript application/json image/svg+xml
  BrowserMatch ^Mozilla/4 gzip-only-text-html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip !gzip-only-text-html
  Header append Vary User-Agent
</IfModule>

# ---------- Caching ----------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML : cache court
  ExpiresByType text/html "access plus 6 hours"

  # CSS/JS
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"

  # Images
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/jpg  "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Fonts
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"

  # Docs
  ExpiresByType application/pdf "access plus 1 week"
  ExpiresByType text/xml "access plus 1 week"
  ExpiresByType application/xml "access plus 1 week"
  ExpiresByType application/rss+xml "access plus 1 week"
</IfModule>

<IfModule mod_headers.c>
  # Cache optimisé
  <FilesMatch "\.(ico|jpg|jpeg|png|gif|svg)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "images/blog/.*\.(webp|jpg|jpeg|png)$">
    Header set Cache-Control "public, max-age=86400, must-revalidate"
  </FilesMatch>
  <FilesMatch "\.(css|js)$">
    Header set Cache-Control "public, max-age=2628000, must-revalidate"
    Header unset ETag
    Header set ETag ""
  </FilesMatch>
  <FilesMatch "\.(html?)$">
    Header set Cache-Control "public, max-age=21600, must-revalidate"
  </FilesMatch>
</IfModule>

# ---------- En-têtes Sécurité ----------
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  # ⚠️ On retire COEP (bloquait les iframes)
  # Header always set Cross-Origin-Opener-Policy "same-origin"   # Optionnel
  # Pas de Cross-Origin-Embedder-Policy

  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"

  # HSTS — active après vérif HTTPS partout
  # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# ---------- CSP compatible avec Tally / Canva / YouTube ----------
<IfModule mod_headers.c>
  Header always set Content-Security-Policy "\
  default-src 'self'; \
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.google.com https://*.googleapis.com https://*.googletagmanager.com https://*.google-analytics.com https://calendly.com https://assets.calendly.com https://tally.so https://*.tally.so https://*.tallycdn.com https://www.canva.com https://*.canva.com; \
  connect-src 'self' https://*.google.com https://*.googleapis.com https://*.google-analytics.com https://*.googletagmanager.com https://calendly.com https://tally.so https://*.tally.so https://*.tallycdn.com; \
  img-src 'self' data: blob: https://*.google.com https://*.googleapis.com https://*.googletagmanager.com https://calendly.com https://i.ytimg.com https://www.canva.com https://*.canva.com https://tally.so https://*.tallycdn.com; \
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://calendly.com https://www.canva.com https://*.canva.com; \
  font-src 'self' https://fonts.gstatic.com; \
  frame-src 'self' https://calendly.com https://tally.so https://*.tally.so https://www.youtube.com https://www.canva.com https://*.canva.com; \
  object-src 'none'; base-uri 'self'; upgrade-insecure-requests"
</IfModule>

# ---------- Pages d'erreur ----------
ErrorDocument 404 /404.html
ErrorDocument 403 /403.html
ErrorDocument 500 /500.html

# ---------- Trailing slash dossiers ----------
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^(.+[^/])$ /$1/ [L,R=301]

# ---------- BONUS : Preload DNS ----------
<IfModule mod_headers.c>
  <FilesMatch "\.(html?)$">
    Header add Link "<https://fonts.googleapis.com>; rel=dns-prefetch"
    Header add Link "<https://www.google-analytics.com>; rel=dns-prefetch"
    Header add Link "<https://calendly.com>; rel=dns-prefetch"
    Header add Link "<https://www.canva.com>; rel=dns-prefetch"
    Header add Link "<https://tally.so>; rel=dns-prefetch"
  </FilesMatch>
</IfModule>

# ---------- ETags ----------
<IfModule mod_headers.c>
  <FilesMatch "^(?!.*(\.css|\.js)).*$">
    Header unset ETag
  </FilesMatch>
</IfModule>
FileETag None
